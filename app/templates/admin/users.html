{% extends "admin/base.html" %}

{% block title %}Utilisateurs - Administration - GoUPJV{% endblock %}

{% block admin_content %}
<h1 class="text-3xl font-bold text-gray-900 mb-6">Gestion des utilisateurs</h1>

{# Search Form #}
<form method="GET" class="mb-6">
    <div class="flex gap-4">
        <input type="text" name="q" value="{{ search_query }}" placeholder="Rechercher..."
            class="flex-grow px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
        <input type="hidden" name="sort" value="{{ sort }}">
        <button type="submit"
            class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all">
            Rechercher
        </button>
        {% if search_query %}
        <a href="{{ url_for('admin.admin_users') }}"
            class="px-6 py-2 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 transition-all">
            Réinitialiser
        </a>
        {% endif %}
    </div>
</form>

{# User Table #}
<div class="bg-white shadow-md rounded-lg overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <a href="{{ url_for('admin.admin_users', sort='desc' if sort == 'asc' else 'asc', q=search_query, page=request.args.get('page', 1)) }}"
                        class="hover:text-blue-600 flex items-center justify-center gap-1">
                        ID
                        {% if sort == 'asc' %}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7">
                            </path>
                        </svg>
                        {% else %}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                        {% endif %}
                    </a>
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ID UPJV
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nom
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Email
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Téléphone
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Statut
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Rôle
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions
                </th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for user in pagination.items %}
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.id }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <a href="{{ url_for('main.public_profile', upjv_id=user.upjv_id) }}" class="hover:underline">
                        {{ user.upjv_id }}
                    </a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ user.first_name }} {{
                    user.last_name }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ user.email }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ user.phone_number or '-' }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span
                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ 'bg-green-100 text-green-800' if user.is_active else 'bg-red-100 text-red-800' }}">
                        {{ 'Actif' if user.is_active else 'Inactif' }}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span
                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ 'bg-purple-100 text-purple-800' if user.is_admin else 'bg-gray-100 text-gray-800' }}">
                        {{ 'Admin' if user.is_admin else 'Utilisateur' }}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button name="toggle-user" data-user-id="{{ user.id }}"
                        class="px-3 py-1 {{ 'bg-red-600 hover:bg-red-700' if user.is_active else 'bg-green-600 hover:bg-green-700' }} text-white rounded hover:shadow transition-all">
                        {{ 'Désactiver' if user.is_active else 'Activer' }}
                    </button>
                    <button name="toggle-admin" data-user-id="{{ user.id }}"
                        class="ml-2 px-3 py-1 {{ 'bg-orange-600 hover:bg-orange-700' if user.is_admin else 'bg-purple-600 hover:bg-purple-700' }} text-white rounded hover:shadow transition-all">
                        {{ 'Retirer admin' if user.is_admin else 'Admin' }}
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">
                    Aucun utilisateur trouvé
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# Pagination #}
{% if pagination.pages > 1 %}
<div class="mt-3 flex justify-center">
    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
        {# Previous Button #}
        {% if pagination.has_prev %}
        <a href="{{ url_for('admin.admin_users', page=pagination.prev_num, sort=sort, q=search_query) }}"
            class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
            Précédent
        </a>
        {% else %}
        <span
            class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
            Précédent
        </span>
        {% endif %}

        {# Page Numbers #}
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
        {% if page_num %}
        {% if page_num == pagination.page %}
        <span
            class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-600 text-sm font-medium text-white">
            {{ page_num }}
        </span>
        {% else %}
        <a href="{{ url_for('admin.admin_users', page=page_num, sort=sort, q=search_query) }}"
            class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
            {{ page_num }}
        </a>
        {% endif %}
        {% else %}
        <span
            class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
            ...
        </span>
        {% endif %}
        {% endfor %}

        {# Next Button #}
        {% if pagination.has_next %}
        <a href="{{ url_for('admin.admin_users', page=pagination.next_num, sort=sort, q=search_query) }}"
            class="relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
            Suivant
        </a>
        {% else %}
        <span
            class="relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
            Suivant
        </span>
        {% endif %}
    </nav>
</div>
{% endif %}

<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}