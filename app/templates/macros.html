{% macro logout_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out-icon lucide-log-out"><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg>
{% endmacro %}

{% macro user_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-user-round-icon lucide-circle-user-round"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
{% endmacro %}

{% macro edit_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen-icon lucide-square-pen"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg>
{% endmacro %}

{% macro trash_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
{% endmacro %}

{% macro nav_link(endpoint, label) %}
<li>
    <a href="{{ url_for(endpoint) }}"
        class="text-gray-700 hover:text-blue-600 font-medium transition-colors duration-200 {% if request.endpoint == endpoint %}underline{% endif %}">{{ label }}</a>
</li>
{% endmacro %}

{% macro logo() %}
<img src="{{ url_for('static', filename='media/logo.svg') }}" alt="Logo">
{% endmacro %}

{% macro flash_messages() %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="w-full rounded-lg p-2 my-4 text-center alert-{{ category }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}
{% endmacro %}

{% macro ride_field(label, value) %}
<div class="flex flex-col">
    <span>{{ label }}</span>
    <span class="text-black">{{ value }}</span>
</div>
{% endmacro %}

{% macro ride(item) %}
<article class="bg-[oklch(96.7%_0.003_264.542)] shadow-md rounded-lg p-4 mb-6 transition-all duration-200">
    
    <div class="md:flex md:items-center gap-4">
        
        <div class="flex items-center justify-center w-20 h-20 bg-indigo-50 text-indigo-700 rounded-lg flex-col shrink-0">
            <span class="text-xs">{{ item.get_month() }}</span>
            <span class="text-2xl font-bold">{{ item.get_day() }}</span>
            <span class="text-xs">{{ item.get_year() }}</span>
        </div>

        <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-3 px-2 mt-4 md:mt-0">
            <div>
                <div class="text-sm text-slate-500">Chauffeur</div>
                <div class="font-medium text-slate-900">{{ item.driver.to_str() }}</div>
            </div>

            <div>
                <div class="text-sm text-slate-500">Places</div>
                <div class="font-medium text-slate-900">
                    {{ item.seats }} libre(s)
                </div>
            </div>

            <div>
                <div class="text-sm text-slate-500">Départ</div>
                <div class="font-medium text-slate-900 leading-tight">
                    {{ item.start_location.name }} 
                    <span class="block text-xs text-slate-600 mt-1">{{ item.get_departure_time() }}</span>
                </div>
            </div>

            <div>
                <div class="text-sm text-slate-500">Arrivée</div>
                <div class="font-medium text-slate-900 leading-tight">
                    {{ item.end_location.name }} 
                    <span class="block text-xs text-slate-600 mt-1">{{ item.get_arrival_time() }}</span>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-end gap-2 mt-4 md:mt-0">
            <button type="button"
                class="btn-toggle-passengers bg-indigo-600 text-white font-medium px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors shadow-sm text-sm whitespace-nowrap" 
                data-ride-id="{{ item.id }}">
                Passagers ({{ item.passengers|length }})
            </button>
        </div>
    </div>

    <div id="passenger-list-{{ item.id }}" class="hidden mt-4 border-t border-indigo-100 pt-4">
        {% if item.passengers %}
            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3">Liste des inscrits</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {% for passenger in item.passengers %}
                <div class="flex items-center gap-3 p-2 rounded-md bg-white border border-slate-100 shadow-sm">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-bold text-xs border border-indigo-200 shrink-0">
                        {{ passenger.first_name[0].upper() }}
                    </div>
                    <div class="flex flex-col overflow-hidden">
                        <span class="text-sm font-semibold text-slate-800 truncate">{{ passenger.first_name }} {{ passenger.last_name }}</span>
                        <span class="text-[10px] text-slate-500 font-mono">ID: {{ passenger.upjv_id }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-sm text-slate-500 italic text-center py-2">Aucun passager inscrit pour le moment.</p>
        {% endif %}
    </div>

</article>
{% endmacro %}

{% macro offer_ride(vehicle) %}

{% set fields = [
    {'sys_name': 'depart',         'label': 'Départ'},
    {'sys_name': 'arrivee',        'label': 'Arrivée'},
    {'sys_name': 'heure_depart',   'label': 'Heure de départ'},
    {'sys_name': 'heure_arrivee',  'label': "Heure d'arrivée"},
    {'sys_name': 'jour',           'label': 'Jour'},
    {'sys_name': 'passagers',      'label': 'Passagers possible'}
] %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
    
    <div class="flex flex-col space-y-6">
    
    {# 2. ON BOUCLE SUR NOS OBJETS #}
    {% for field in fields %}
        
        {# On utilise field.sys_name pour les IDs (pas de risque d'apostrophe ici !) #}
        <div id="container-{{ field.sys_name }}" 
             class="border-b-2 border-gray-200 pb-2 transition-all duration-300 group">
            
            {# On passe le nom système au JavaScript #}
            <div onclick="toggleInput('{{ field.sys_name }}')" class="flex justify-between items-center cursor-pointer">
                
                {# Ici on affiche le JOLI texte pour l'humain #}
                <span class="text-gray-400 font-bold text-xl group-hover:text-indigo-500 transition-colors">
                    {{ field.label }}
                </span>

                <div class="bg-gray-100 rounded-md p-2 text-gray-400 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition-colors">
                    <svg id="icon-{{ field.sys_name }}" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>

            {# Zone d'input avec ID système #}
            <div id="input-area-{{ field.sys_name }}" class="hidden mt-3">
                
                {# 3. ON VÉRIFIE LE NOM SYSTÈME (plus sûr que le texte) #}
                
                {% if field.sys_name == 'depart' %}
                    <input type="text" name="start_location" placeholder="Ville de départ..." 
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                        onclick="event.stopPropagation()"> 
                {% endif %}
                
                {% if field.sys_name == 'arrivee' %}
                    <input type="text" name="end_location" placeholder="Ville d'arrivée..." 
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                        onclick="event.stopPropagation()"> 
                {% endif %}

                {% if field.sys_name == 'heure_depart' %}
                    <input type="time" name="departure_time" 
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                        onclick="event.stopPropagation()"> 
                {% endif %}

                {% if field.sys_name == 'heure_arrivee' %}
                    <input type="time" name="arrival_time" 
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                        onclick="event.stopPropagation()"> 
                {% endif %}

                {% if field.sys_name == 'jour' %}
                    <input type="date" name="ride_date" 
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                        onclick="event.stopPropagation()"> 
                {% endif %}

                {% if field.sys_name == 'passagers' %}
                    <input type="number" name="seats" min="1" max="8" placeholder="{{ vehicle.max_seats }} maximum"
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                        onclick="event.stopPropagation()"> 
                {% endif %}
            </div>

        </div>
    {% endfor %}
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 sticky top-4">
        <h2 class="text-2xl font-extrabold mb-6">Informations du véhicule</h2>
        
        <div class="mb-4">
            <p class="text-gray-400 font-bold text-sm">Marque</p>
            <p class="font-extrabold text-xl">{{ vehicle.model.split(' ', 1)[1]|default('Inconnu') }}</p>
        </div>

        <div class="mb-4">
            <p class="text-gray-400 font-bold text-sm">Modèle du véhicule</p>
            <p class="font-extrabold text-xl">{{ vehicle.model.split(' ', 1)[0]|default('Inconnu') }}</p>
        </div>

        <div class="mb-6">
            <p class="text-gray-400 font-bold text-sm">Immatriculation</p>
            <p class="font-extrabold text-xl">{{ vehicle.licence_plate|default('XX-000-XX') }}</p>
        </div>

        <div class="mb-2">
            <p class="text-gray-400 font-bold text-sm mb-2">Véhicule</p>
            <img src="https://img.gta5-mods.com/q95/images/dababy-car/5edd98-download.png" alt="{{ vehicle.model }}" class="w-full h-48 object-cover rounded-lg shadow-sm bg-gray-200">
        </div>
    </div>
</div>

<button class="mt-12 w-full bg-[#4655f5] hover:bg-blue-700 text-white font-bold text-xl py-4 px-6 rounded-lg flex justify-between items-center transition duration-300 shadow-md group">
    Mettre en ligne
    <svg class="w-8 h-8 transform group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
</button>
{% endmacro %}