{% macro logout_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out-icon lucide-log-out"><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg>
{% endmacro %}

{% macro user_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-user-round-icon lucide-circle-user-round"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
{% endmacro %}

{% macro edit_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen-icon lucide-square-pen"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg>
{% endmacro %}

{% macro trash_icon() %}
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
{% endmacro %}

{% macro nav_link(endpoint, label) %}
<li>
    <a href="{{ url_for(endpoint) }}"
        class="text-gray-700 hover:text-blue-600 font-medium transition-colors duration-200 {% if request.endpoint == endpoint %}underline{% endif %}">{{ label }}</a>
</li>
{% endmacro %}

{% macro logo() %}
<img src="{{ url_for('static', filename='media/logo.svg') }}" alt="Logo">
{% endmacro %}

{% macro flash_messages() %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="w-full rounded-lg p-2 my-4 text-center alert-{{ category }}">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}
{% endmacro %}

{% macro ride_field(label, value) %}
<div class="flex flex-col">
    <span>{{ label }}</span>
    <span class="text-black">{{ value }}</span>
</div>
{% endmacro %}

{% macro ride(item) %}
<article class="bg-[oklch(96.7%_0.003_264.542)] shadow-md rounded-lg p-4 mb-6 transition-all duration-200">

    <div class="md:flex md:items-center gap-4">

        <div class="flex items-center justify-center w-20 h-20 bg-indigo-50 text-indigo-700 rounded-lg flex-col shrink-0">
            <span class="text-xs">{{ item.get_month() }}</span>
            <span class="text-2xl font-bold">{{ item.get_day() }}</span>
            <span class="text-xs">{{ item.get_year() }}</span>
        </div>

        <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-3 px-2 mt-4 md:mt-0">
            <div>
                <div class="text-sm text-slate-500">Chauffeur</div>
                <div class="font-medium text-slate-900">{{ item.driver.to_str() }}</div>
            </div>

            <div>
                <div class="text-sm text-slate-500">Places</div>
                <div class="font-medium text-slate-900">
                    {{ item.seats }} libre(s)
                </div>
            </div>

            <div>
                <div class="text-sm text-slate-500">Départ</div>
                <div class="font-medium text-slate-900 leading-tight">
                    {{ item.start_location.name }}
                    <span class="block text-xs text-slate-600 mt-1">{{ item.get_departure_time() }}</span>
                </div>
            </div>

            <div>
                <div class="text-sm text-slate-500">Arrivée</div>
                <div class="font-medium text-slate-900 leading-tight">
                    {{ item.end_location.name }}
                    <span class="block text-xs text-slate-600 mt-1">{{ item.get_arrival_time() }}</span>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-end gap-2 mt-4 md:mt-0">
            <button type="button"
                class="btn-toggle-passengers bg-indigo-600 text-white font-medium px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors shadow-sm text-sm whitespace-nowrap"
                data-ride-id="{{ item.id }}">
                Passagers ({{ item.passengers|length }})
            </button>
        </div>
    </div>

    <div id="passenger-list-{{ item.id }}" class="hidden mt-4 border-t border-indigo-100 pt-4">
        {% if item.passengers %}
        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3">Liste des inscrits</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {% for passenger in item.passengers %}
            <div class="flex items-center gap-3 p-2 rounded-md bg-white border border-slate-100 shadow-sm">
                <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-bold text-xs border border-indigo-200 shrink-0">
                    {{ passenger.first_name[0].upper() }}
                </div>
                <div class="flex flex-col overflow-hidden">
                    <a href="{{ url_for('main.public_profile', upjv_id=passenger.upjv_id) }}" class="text-sm font-semibold text-slate-800 truncate">{{ passenger.first_name }} {{ passenger.last_name }}</a>
                    <span class="text-[10px] text-slate-500 font-mono">ID: {{ passenger.upjv_id }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-slate-500 italic text-center py-2">Aucun passager inscrit pour le moment.</p>
        {% endif %}
    </div>

</article>
{% endmacro %}

{% macro offer_ride(sys_name, label) %}
<div id="container-{{ sys_name }}" 
     class="border-b-2 border-gray-200 pb-2 transition-all duration-300 group">

    {# En-tête cliquable #}
    <div onclick="toggleInput('{{ sys_name }}')" class="flex justify-between items-center cursor-pointer">
        <span class="text-gray-400 font-bold text-xl group-hover:text-indigo-500 transition-colors">
            {{ label }}
        </span>

        <div class="bg-gray-100 rounded-md p-2 text-gray-400 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition-colors">
            <svg id="icon-{{ sys_name }}" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
    </div>

    {# Zone de contenu caché (l'input sera inséré ici grâce à caller()) #}
    <div id="input-area-{{ sys_name }}" class="hidden mt-3">
        {{ caller() }}
    </div>

</div>
{% endmacro %}

{% macro star_rating(rating, size='text-lg') %}
<div class="flex items-center gap-0.5">
    {% for i in range(1, 6) %}
    {% if i <= rating|int %}
        <span class="{{ size }} text-yellow-400">★</span>
    {% elif i - 0.5 <= rating %}
        <span class="{{ size }} text-yellow-400">★</span>
    {% else %}
        <span class="{{ size }} text-gray-300">★</span>
    {% endif %}
    {% endfor %}
    <span class="text-sm text-gray-600 ml-1">({{ "%.1f"|format(rating) }})</span>
</div>
{% endmacro %}

{% macro account_metadata(user) %}
<div class="mt-6 pt-6 border-t border-gray-200">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <p class="text-sm text-gray-600">Membre depuis</p>
            <p class="text-sm font-medium text-gray-900">{{ user.created_at.strftime('%d/%m/%Y') }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-600">Statut du compte</p>
            <p class="text-sm font-medium">
                {% if user.is_admin %}
                <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-500 text-white">Admin</span>
                {% elif user.is_active %}
                <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Actif</span>
                {% else %}
                <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Inactif</span>
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endmacro %}

{% macro vehicle_card(vehicle) %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="p-4 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600 mb-1">Modèle</p>
        <p class="font-medium text-gray-900">{{ vehicle.model }}</p>
    </div>
    <div class="p-4 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600 mb-1">Couleur</p>
        <p class="font-medium text-gray-900">{{ vehicle.color if vehicle.color else '-' }}</p>
    </div>
    <div class="p-4 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600 mb-1">Immatriculation</p>
        <p class="font-medium text-gray-900">{{ vehicle.licence_plate }}</p>
    </div>
    <div class="p-4 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600 mb-1">Places disponibles</p>
        <p class="font-medium text-gray-900">{{ vehicle.max_seats }}</p>
    </div>
</div>
<div class="mt-4">
    <p class="text-sm text-gray-600 mb-2">Photo du véhicule</p>
    {% if vehicle.image_path %}
    <img src="{{ url_for('static', filename='uploads/vehicles/' + vehicle.image_path) }}" alt="{{ vehicle.model }}"
        class="w-full h-48 object-cover rounded-lg shadow-sm">
    {% else %}
    <div class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center">
        <p class="text-gray-400 text-sm">Aucune photo</p>
    </div>
    {% endif %}
</div>
{% endmacro %}

{% macro review_card(review) %}
<div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
    <div class="flex items-start justify-between mb-2">
        <div>
            <a href="{{ url_for('main.public_profile', upjv_id=review.author.upjv_id) }}" class="font-medium text-gray-900 hover:underline">{{ review.author.first_name }} {{ review.author.last_name }}</a>
            <p class="text-xs text-gray-500">{{ review.ride.date.strftime('%d/%m/%Y') }}</p>
        </div>
        <div class="flex items-center gap-0.5">
            {% for i in range(1, 6) %}
            {% if i <= review.rating %}
                <span class="text-yellow-400">★</span>
            {% else %}
                <span class="text-gray-300">★</span>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% if review.content %}
    <p class="text-gray-700 text-sm">{{ review.content }}</p>
    {% else %}
    <p class="text-gray-400 text-sm italic">Aucun commentaire</p>
    {% endif %}
</div>
{% endmacro %}